<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABS RemoveX Pro+ - Remove Background & Convert</title>
    <style>
        /* --- Reset & Base --- */
        :root {
            --primary-color: #0056b3; --secondary-color: #6c757d; --success-color: #28a745;
            --warning-color: #ffc107; --danger-color: #dc3545; --light-gray: #f8f9fa;
            --medium-gray: #e9ecef; --dark-gray: #495057; --text-color: #343a40; --white: #ffffff;
            --border-radius: 6px; --box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; } /* Ensure html takes full height */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6; color: var(--text-color); background-color: var(--light-gray);
            display: flex; flex-direction: column; min-height: 100%; /* Ensure body takes full height */
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }
        .site-wrapper { /* New wrapper for flex column */
            display: flex; flex-direction: column; flex-grow: 1;
        }
        a { color: var(--primary-color); text-decoration: none; transition: color 0.2s ease; }
        a:hover { color: darken(var(--primary-color), 10%); text-decoration: underline; }
        button {
            cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: 500; border: none;
            border-radius: var(--border-radius); padding: 0.7em 1.4em;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        button:active { transform: translateY(1px); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        img { max-width: 100%; display: block; height: auto; }

        /* --- Header --- */
        .app-header { /* Styles remain the same */
            display: flex; justify-content: center; align-items: center; padding: 1.2rem 2rem;
            background-color: var(--white); border-bottom: 1px solid var(--medium-gray);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-shrink: 0; /* Prevent header shrinking */
        }
        .logo { /* Styles remain the same */
            font-weight: 600; font-size: 1.8rem; color: var(--dark-gray);
        }
        .logo .part1 { color: var(--primary-color); }
        .logo .part2 { font-weight: 400; color: #5a6268; }
        .logo .pro-badge {
             font-size: 1.1rem; font-weight: 600; vertical-align: middle; margin-left: 8px; color: var(--primary-color);
             background-color: rgba(0, 86, 179, 0.1); padding: 0.1em 0.4em; border-radius: 4px;
        }

        /* --- Main Content --- */
        .main-content {
             flex-grow: 1; /* Allow main content to grow */
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             padding: 3rem 1rem; text-align: center; width: 100%;
        }
        .content-wrapper { width: 100%; max-width: 700px; display: flex; flex-direction: column; align-items: center; }
        .hero-text { margin-bottom: 2rem; }
        .hero-text h1 { font-size: 2.8rem; font-weight: 700; margin-bottom: 0.7rem; color: #212529; line-height: 1.25; }
        .hero-text p { font-size: 1.2rem; color: var(--dark-gray); }
        .free-badge { background-color: var(--warning-color); color: #333; padding: 0.25em 0.6em; border-radius: 4px; font-weight: 600; margin-left: 5px; display: inline-block; vertical-align: baseline; font-size: 0.9em; }

        /* --- Upload Section --- */
        .upload-section { width: 100%; max-width: 600px; background-color: var(--white); padding: 2rem 2.5rem; border-radius: 8px; box-shadow: var(--box-shadow); border: 1px solid var(--medium-gray); margin-bottom: 2rem; }
        .upload-area { border: 2px dashed #ced4da; border-radius: var(--border-radius); padding: 2rem; text-align: center; width: 100%; margin-bottom: 1.5rem; background-color: var(--light-gray); transition: border-color 0.3s ease, background-color 0.3s ease; position: relative; min-height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .upload-area.drag-over { border-color: var(--primary-color); background-color: #e9f5ff; }
        .upload-controls { display: flex; flex-direction: column; align-items: center; gap: 1.2rem; width: 100%; }
        .upload-controls.hidden { display: none; }
        .upload-button { background-color: var(--primary-color); color: white; width: 80%; max-width: 300px; }
        .upload-button:hover { background-color: darken(var(--primary-color), 10%); }
        .url-upload-button { background-color: var(--secondary-color); color: white; width: 80%; max-width: 300px; }
        .url-upload-button:hover { background-color: darken(var(--secondary-color), 10%); }
        p.drop-text { color: #6c757d; font-size: 1rem; margin-top: 0.8rem; }

        /* --- Loader --- */
        .loader { display: none; margin: 2rem auto; font-size: 10px; position: relative; text-indent: -9999em; border-top: 0.7em solid rgba(0, 86, 179, 0.2); border-right: 0.7em solid rgba(0, 86, 179, 0.2); border-bottom: 0.7em solid rgba(0, 86, 179, 0.2); border-left: 0.7em solid var(--primary-color); transform: translateZ(0); animation: load8 1.1s infinite linear; border-radius: 50%; width: 70px; height: 70px; }
        .loader.visible { display: block; }
        @keyframes load8 { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Status Message --- */
        .status-message { margin-top: 1.5rem; font-weight: 500; text-align: center; min-height: 1.6em; padding: 0 1rem; width: 100%; color: var(--secondary-color); transition: color 0.3s ease; font-size: 1.05rem; }
        .status-message.error { color: var(--danger-color); font-weight: 600; }
        .status-message.success { color: var(--success-color); }

        /* --- Result Area --- */
        .result-area { display: none; flex-direction: column; align-items: center; width: 100%; opacity: 0; transform: translateY(20px); transition: opacity 0.6s ease, transform 0.6s ease; }
        .result-area.visible { display: flex; opacity: 1; transform: translateY(0); }
        .result-container { display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap; width: 100%; margin-bottom: 2rem; }
        .image-box { border: 1px solid var(--medium-gray); padding: 15px; border-radius: var(--border-radius); background-color: var(--white); text-align: center; max-width: 330px; flex: 1 1 300px; box-shadow: var(--box-shadow); transition: transform 0.2s ease; overflow: hidden; }
        .image-box:hover { transform: translateY(-3px); }
        .image-box h3 { font-size: 1.1rem; font-weight: 600; color: var(--dark-gray); margin-bottom: 15px; }
        .image-box img { max-height: 300px; margin: 0 auto 15px auto; background-image: linear-gradient(45deg, #e8e8e8 25%, transparent 25%), linear-gradient(-45deg, #e8e8e8 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #e8e8e8 75%), linear-gradient(-45deg, transparent 75%, #e8e8e8 75%); background-size: 18px 18px; background-position: 0 0, 0 9px, 9px -9px, -9px 0px; border: 1px solid var(--medium-gray); border-radius: 4px; }

        /* --- Download Area --- */
         .download-area { position: relative; /* For dropdown positioning */ }
        .download-button-main { /* The main button that triggers dropdown */
             background-color: var(--success-color); color: white; padding: 10px 28px; font-size: 1.05rem; display: inline-flex; align-items: center; gap: 0.5em;
        }
         .download-button-main svg { width: 1em; height: 1em; fill: currentColor; }
        .download-button-main:hover { background-color: darken(var(--success-color), 10%); }
        .download-button-main.disabled { background-color: #adb5bd; cursor: not-allowed; pointer-events: none; box-shadow: none; }

        .download-options { /* The dropdown menu */
             position: absolute; bottom: 100%; /* Position above button */
             left: 50%; transform: translateX(-50%) translateY(-10px); /* Center and add space */
             background-color: var(--white); border-radius: var(--border-radius);
             box-shadow: 0 3px 10px rgba(0,0,0,0.15); z-index: 10;
             display: none; /* Hidden by default */
             flex-direction: column; padding: 0.5rem 0;
             min-width: 100px; /* Minimum width */
             border: 1px solid var(--medium-gray);
             opacity: 0; visibility: hidden;
             transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
        }
         .download-options.visible {
             display: flex; opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-5px);
         }

        .download-options button {
             background: none; box-shadow: none; border-radius: 0; padding: 0.6rem 1.2rem;
             text-align: left; width: 100%; color: var(--text-color); font-weight: 400;
             transition: background-color 0.15s ease;
        }
        .download-options button:hover { background-color: var(--light-gray); }
        .download-options button:active { transform: none; }

        #tryAnotherButton { background-color: var(--secondary-color); color: white; margin-top: 2rem; }
        #tryAnotherButton:hover { background-color: darken(var(--secondary-color), 10%); }

        /* --- URL Input Modal (Styles remain the same) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--white); padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-width: 500px; width: 90%; position: relative; text-align: left; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: var(--dark-gray); }
        .modal-body label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .modal-body input[type="url"] { width: 100%; padding: 0.8rem 1rem; border: 1px solid #ced4da; border-radius: var(--border-radius); font-size: 1rem; margin-bottom: 1.5rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .modal-body input[type="url"]:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 0.2rem rgba(0, 86, 179, 0.25); }
        .modal-footer { display: flex; justify-content: flex-end; gap: 0.8rem; }
        .modal-button { padding: 0.6em 1.2em; font-size: 0.95rem; }
        .modal-button-primary { background-color: var(--primary-color); color: var(--white); }
        .modal-button-primary:hover { background-color: darken(var(--primary-color), 10%); }
        .modal-button-secondary { background-color: var(--secondary-color); color: var(--white); }
        .modal-button-secondary:hover { background-color: darken(var(--secondary-color), 10%); }
        .modal-close-button { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.8rem; color: var(--secondary-color); line-height: 1; padding: 0.2rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s ease; box-shadow: none; }
        .modal-close-button:hover { opacity: 1; }

        /* --- Footer --- */
        .app-footer {
            flex-shrink: 0; /* Prevent footer shrinking */
            padding: 1.5rem 1rem;
            background-color: var(--white);
            border-top: 1px solid var(--medium-gray);
            text-align: center;
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-top: auto; /* Push footer to bottom */
        }
        .app-footer a {
            color: var(--primary-color);
            font-weight: 500;
        }
        .app-footer a:hover {
             color: darken(var(--primary-color), 10%);
        }

        /* --- Hidden Input --- */
        #fileInput { display: none; }

        /* --- Responsiveness (Styles remain similar) --- */
        @media (max-width: 768px) { /* ... previous responsive styles ... */ }
        @media (max-width: 500px) { /* ... previous responsive styles ... */ }

    </style>
</head>
<body>
<div class="site-wrapper"> <!-- Wrap everything for flex column layout -->
    <header class="app-header">
        <div class="logo">
             <span class="part1">ABS</span><span class="part2">RemoveX</span><span class="pro-badge">Pro+</span>
        </div>
    </header>

    <main class="main-content">
        <div class="content-wrapper">
            <div class="hero-text" id="heroText">
                <h1>Effortless Background Removal</h1>
                <p>Upload an image or URL. AI powered, fast & <span class="free-badge">Free</span></p>
            </div>

            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-area" id="dropZone">
                    <div class="loader" id="loader">Loading...</div>
                    <div class="upload-controls" id="uploadControls">
                        <button class="upload-button" id="uploadButton">Upload Image</button>
                        <button class="url-upload-button" id="urlModalButton">Upload from URL</button>
                        <p class="drop-text">or drop a file here</p>
                    </div>
                    <input type="file" id="fileInput" accept="image/png, image/jpeg, image/webp">
                </div>
                <div id="statusMessage" class="status-message"></div>
            </div>

            <!-- Result Area (initially hidden) -->
            <div class="result-area" id="resultArea">
                <div class="result-container">
                    <div class="image-box">
                        <h3>Original</h3>
                        <img id="originalImage" src="#" alt="Original Image Preview">
                    </div>
                    <div class="image-box">
                        <h3>Background Removed</h3>
                        <img id="resultImage" src="#" alt="Background Removed Preview">
                        <!-- Download Area with Dropdown -->
                        <div class="download-area">
                             <button id="downloadButtonMain" class="download-button-main disabled">
                                 Download
                                 <svg viewBox="0 0 20 20" focusable="false" aria-hidden="true"><path d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z"></path></svg>
                             </button>
                             <div id="downloadOptions" class="download-options">
                                 <button data-format="png">PNG</button>
                                 <button data-format="jpg">JPG</button>
                                 <button data-format="webp">WEBP</button>
                             </div>
                        </div>
                    </div>
                </div>
                <button id="tryAnotherButton" class="upload-button" style="background-color: var(--secondary-color);">Upload Another</button>
            </div>
        </div>
    </main>

    <!-- URL Input Modal (HTML remains the same) -->
    <div class="modal-overlay" id="urlModalOverlay">
        <div class="modal-content">
            <button class="modal-close-button" id="modalCloseButton" aria-label="Close">×</button>
            <div class="modal-header"><h2 class="modal-title">Upload Image from URL</h2></div>
            <div class="modal-body">
                 <label for="modalUrlInput">Paste image URL below:</label>
                 <input type="url" id="modalUrlInput" placeholder="https://example.com/image.jpg">
                 <div id="modalStatusMessage" class="status-message" style="min-height: 1em; margin-top: 0; margin-bottom: 1rem; font-size: 0.9rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-button modal-button-secondary" id="modalCancelButton">Cancel</button>
                <button class="modal-button modal-button-primary" id="modalSubmitUrlButton">Submit URL</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        Powered By: <a href="https://t.me/absstudiox" target="_blank" rel="noopener noreferrer">ABS StudioX</a>
    </footer>
</div> <!-- End site-wrapper -->

    <script>
        // --- Configuration ---
        const apiKey = 'j1abJCgNtVp4dmASiz1FiVUF'; // **WARNING: Do not expose in production!**
        const apiUrl = 'https://api.remove.bg/v1.0/removebg';
        const MAX_FILE_SIZE_MB = 15;

        // --- DOM Elements ---
        const dropZone = document.getElementById('dropZone');
        const uploadControls = document.getElementById('uploadControls');
        const uploadButton = document.getElementById('uploadButton');
        const urlModalButton = document.getElementById('urlModalButton');
        const fileInput = document.getElementById('fileInput');
        const loader = document.getElementById('loader');
        const statusMessage = document.getElementById('statusMessage');
        const resultArea = document.getElementById('resultArea');
        const originalImage = document.getElementById('originalImage');
        const resultImage = document.getElementById('resultImage');
        const tryAnotherButton = document.getElementById('tryAnotherButton');
        const heroText = document.getElementById('heroText');
        const uploadSection = document.getElementById('uploadSection');
        // Download Elements
        const downloadButtonMain = document.getElementById('downloadButtonMain');
        const downloadOptions = document.getElementById('downloadOptions');
        // Modal elements
        const urlModalOverlay = document.getElementById('urlModalOverlay');
        const modalUrlInput = document.getElementById('modalUrlInput');
        const modalSubmitUrlButton = document.getElementById('modalSubmitUrlButton');
        const modalCancelButton = document.getElementById('modalCancelButton');
        const modalCloseButton = document.getElementById('modalCloseButton');
        const modalStatusMessage = document.getElementById('modalStatusMessage');

        // --- State ---
        let currentResultBlob = null; // Store the result Blob itself
        let currentResultBlobUrl = null; // Store the URL for the result Blob (used for preview)
        let originalFileName = 'image_no_bg.png';

        // --- Event Listeners ---
        uploadButton.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files?.[0];
            if (file) handleFile(file);
        });
        tryAnotherButton.addEventListener('click', resetUI);
        dropZone.addEventListener('dragover', handleDragOver);
        dropZone.addEventListener('dragleave', handleDragLeave);
        dropZone.addEventListener('drop', handleDrop);
        urlModalButton.addEventListener('click', openUrlModal);
        modalCloseButton.addEventListener('click', closeUrlModal);
        modalCancelButton.addEventListener('click', closeUrlModal);
        urlModalOverlay.addEventListener('click', (e) => { if (e.target === urlModalOverlay) closeUrlModal(); });
        modalSubmitUrlButton.addEventListener('click', handleModalUrlSubmit);
        modalUrlInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleModalUrlSubmit(); });

        // Download Listener
        downloadButtonMain.addEventListener('click', (e) => {
             e.stopPropagation(); // Prevent body click listener from closing it immediately
             if (downloadButtonMain.classList.contains('disabled')) return;
             downloadOptions.classList.toggle('visible');
        });

        // Download Option Listeners
        downloadOptions.addEventListener('click', (e) => {
             if (e.target.tagName === 'BUTTON' && e.target.dataset.format) {
                 const format = e.target.dataset.format;
                 downloadResult(format);
                 downloadOptions.classList.remove('visible'); // Hide after selection
             }
         });

        // Close dropdown when clicking outside
         document.addEventListener('click', (e) => {
             if (!downloadButtonMain.contains(e.target) && !downloadOptions.contains(e.target)) {
                 downloadOptions.classList.remove('visible');
             }
         });


        // --- Drag & Drop Handlers ---
        function handleDragOver(e) { /* ... same as before ... */ e.preventDefault(); if (!loader.classList.contains('visible')) dropZone.classList.add('drag-over'); }
        function handleDragLeave() { /* ... same as before ... */ dropZone.classList.remove('drag-over'); }
        function handleDrop(e) { /* ... same as before ... */ e.preventDefault(); if (loader.classList.contains('visible')) return; dropZone.classList.remove('drag-over'); const file = e.dataTransfer.files?.[0]; if (file) handleFile(file); else showStatus('No file detected in drop.', true, statusMessage); }

        // --- Modal Functions ---
        function openUrlModal() { /* ... same as before ... */ modalUrlInput.value = ''; modalStatusMessage.textContent = ''; modalStatusMessage.className = 'status-message'; urlModalOverlay.classList.add('visible'); modalUrlInput.focus(); }
        function closeUrlModal() { /* ... same as before ... */ urlModalOverlay.classList.remove('visible'); }
        function handleModalUrlSubmit() { /* ... same as before ... */ const url = modalUrlInput.value.trim(); if (!url) { showStatus('Please enter a valid URL.', true, modalStatusMessage); return; } try { new URL(url); } catch (_) { showStatus('Invalid URL format.', true, modalStatusMessage); return; } closeUrlModal(); handleUrlUpload(url); }

        // --- Core Processing Logic ---
        async function handleUrlUpload(url) { /* ... mostly same as before ... */
             showLoadingState(); showStatus('Fetching image from URL...', false, statusMessage);
             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`Failed to fetch: ${response.status} ${response.statusText}`);
                 const contentType = response.headers.get('content-type');
                 if (!contentType?.startsWith('image/')) throw new Error('URL did not point to a valid image.');
                 const blob = await response.blob();
                 if (blob.size > MAX_FILE_SIZE_MB * 1024 * 1024) throw new Error(`Image from URL exceeds ${MAX_FILE_SIZE_MB}MB limit.`);
                 let filename = url.substring(url.lastIndexOf('/') + 1).split('?')[0] || 'image_from_url';
                 if (!filename.includes('.') && contentType.split('/')[1]) { filename += '.' + contentType.split('/')[1].split('+')[0].toLowerCase(); }
                 const fileObject = new File([blob], filename, { type: blob.type });
                 await handleFile(fileObject);
             } catch (error) { console.error('URL Fetch Error:', error); let message = `Error fetching URL: ${error.message}.`; if (error instanceof TypeError) { message += ' (Check CORS/network).'; } resetUI(); showStatus(message, true, statusMessage); }
        }

        async function handleFile(file) { /* ... validation same as before ... */
             if (!file.type.startsWith('image/')) { showStatus('Error: Please upload an image file.', true, statusMessage); if (fileInput) fileInput.value = ''; return; }
             const fileSizeMB = file.size / 1024 / 1024;
             if (fileSizeMB > MAX_FILE_SIZE_MB) { showStatus(`Error: File size (${fileSizeMB.toFixed(1)}MB) exceeds ${MAX_FILE_SIZE_MB}MB limit.`, true, statusMessage); if (fileInput) fileInput.value = ''; return; }

             originalFileName = file.name;
             cleanupResultData(); // Use new cleanup function
             showLoadingState();
             showStatus('Reading file...', false, statusMessage);

             try {
                 const dataUrl = await readFileAsDataURL(file); originalImage.src = dataUrl;
             } catch (readError) { resetUI(); showStatus('Error reading the selected file.', true, statusMessage); return; }

             showStatus('Removing background...', false, statusMessage);
             try {
                 const formData = new FormData(); formData.append("size", "auto"); formData.append("image_file", file);
                 const response = await fetch(apiUrl, { method: "POST", headers: { "X-Api-Key": apiKey }, body: formData });

                 if (!response.ok) { let errorMsg = `API Error: ${response.status} ${response.statusText}`; try { const errData = await response.json(); errorMsg = errData.errors?.[0]?.title || errorMsg; } catch (_) {} throw new Error(errorMsg); }

                 const resultArrayBuffer = await response.arrayBuffer();
                 if (!resultArrayBuffer || resultArrayBuffer.byteLength === 0) throw new Error('API returned empty data.');

                 // Store the result Blob and create its URL
                 currentResultBlob = new Blob([resultArrayBuffer], { type: 'image/png' }); // Assume PNG from API
                 currentResultBlobUrl = URL.createObjectURL(currentResultBlob);
                 resultImage.src = currentResultBlobUrl;

                 downloadButtonMain.classList.remove('disabled'); // Enable download button
                 showResultState();
                 showStatus('Background removed successfully!', false, statusMessage, true);

             } catch (error) { console.error('API/Processing Error:', error); resetUI(); let userMessage = `Error: ${error.message}`; if (error.message.includes('API key') || error.message.includes('credits')) { userMessage += ' (Check API Key/Credits).'; } showStatus(userMessage, true, statusMessage); }
        }

        // --- Helper: Read File ---
        function readFileAsDataURL(file) { /* ... same as before ... */ return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = (error) => reject(error); reader.readAsDataURL(file); }); }

        // --- Download Logic ---
        function downloadResult(format = 'png') {
            if (!currentResultBlob) {
                 showStatus('Error: No result image data available.', true, statusMessage);
                 return;
            }

            const baseFilename = originalFileName.substring(0, originalFileName.lastIndexOf('.')) || originalFileName;
            const filename = `${baseFilename}_no_bg.${format}`;

            switch (format) {
                case 'png':
                    downloadBlob(currentResultBlob, filename);
                    break;
                case 'jpg':
                case 'jpeg':
                    convertAndDownload(currentResultBlobUrl, 'image/jpeg', filename, 0.9); // Quality 0.9
                    break;
                case 'webp':
                    convertAndDownload(currentResultBlobUrl, 'image/webp', filename, 0.9); // Quality 0.9
                    break;
                default:
                    showStatus(`Error: Unsupported download format "${format}".`, true, statusMessage);
            }
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up blob URL
        }

        function convertAndDownload(imageUrl, mimeType, filename, quality = 0.9) {
             const img = new Image();
             img.onload = () => {
                 try {
                     const canvas = document.createElement('canvas');
                     canvas.width = img.naturalWidth;
                     canvas.height = img.naturalHeight;
                     const ctx = canvas.getContext('2d');

                     // Draw image onto canvas (consider background color for JPG)
                     if (mimeType === 'image/jpeg') {
                          ctx.fillStyle = '#FFFFFF'; // Set white background for JPG transparency
                          ctx.fillRect(0, 0, canvas.width, canvas.height);
                     }
                     ctx.drawImage(img, 0, 0);

                     // Get data URL and trigger download
                     const dataUrl = canvas.toDataURL(mimeType, quality);
                     const a = document.createElement('a');
                     a.href = dataUrl;
                     a.download = filename;
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                 } catch (e) {
                      console.error("Canvas conversion error:", e);
                      showStatus('Error converting image format.', true, statusMessage);
                 }
             };
             img.onerror = () => {
                  showStatus('Error loading result image for conversion.', true, statusMessage);
             };
             img.src = imageUrl; // Load the image from the blob URL
        }


        // --- UI Update Functions ---
        function showLoadingState() { /* ... same as before ... */ uploadControls.classList.add('hidden'); loader.classList.add('visible'); resultArea.classList.remove('visible'); statusMessage.textContent = 'Initializing...'; statusMessage.className = 'status-message'; heroText.style.display = 'none'; downloadButtonMain.classList.add('disabled'); downloadOptions.classList.remove('visible'); originalImage.src = '#'; resultImage.src = '#'; dropZone.style.cursor = 'default'; }
        function showResultState() { /* ... same as before ... */ uploadSection.style.display = 'none'; loader.classList.remove('visible'); resultArea.classList.add('visible'); }
        function showStatus(message, isError = false, element = statusMessage, isSuccess = false) { /* ... same as before ... */ element.textContent = message; let classes = 'status-message'; if (isError) classes += ' error'; else if (isSuccess) classes += ' success'; element.className = classes; }

        function resetUI() {
            cleanupResultData(); // Use new cleanup function
            statusMessage.textContent = ''; statusMessage.className = 'status-message'; resultArea.classList.remove('visible'); loader.classList.remove('visible'); uploadControls.classList.remove('hidden'); uploadSection.style.display = 'block'; heroText.style.display = 'block'; originalImage.src = '#'; resultImage.src = '#';
            downloadButtonMain.classList.add('disabled'); // Ensure download button is disabled
            downloadOptions.classList.remove('visible'); // Hide dropdown
            if(fileInput) fileInput.value = ''; originalFileName = 'image_no_bg.png'; dropZone.classList.remove('drag-over'); dropZone.style.cursor = 'pointer';
        }

        function cleanupResultData() { // Renamed cleanup function
             if (currentResultBlobUrl) { URL.revokeObjectURL(currentResultBlobUrl); }
             currentResultBlobUrl = null;
             currentResultBlob = null; // Also clear the stored blob
        }

        // --- Initial Setup ---
        resetUI();
    </script>

</body>
</html>
